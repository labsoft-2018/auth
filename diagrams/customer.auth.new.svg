<?xml version="1.0" encoding="utf-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"><svg xmlns="http://www.w3.org/2000/svg" width="1149" height="705" xmlns:xlink="http://www.w3.org/1999/xlink"><source><![CDATA[Title: Customer auth flow - new user
CustomerMobile->Auth: /sign-in-facebook :facebookToken
Auth->*Facebook*: Verify token
*Facebook*->Auth: fbUser
Auth->User: get user by fbUser.id
User->Auth: null
Auth->User: createUser {:type :customer :email fbUser.email}
User->Auth: user
Auth->Credential: createCredential :user user :type 'facebook' :fb-id fbUser.id
Auth->Customer: /create-customer :name fbUser.name :photo fbUser.photo
Customer->Auth: customer
Note over Auth: Generate token for user
Auth->CustomerMobile: 200 token]]></source><desc>Customer auth flow - new user</desc><defs><marker viewBox="0 0 5 5" markerWidth="5" markerHeight="5" orient="auto" refX="5" refY="2.5" id="markerArrowBlock"><path d="M 0 0 L 5 2.5 L 0 5 z"></path></marker><marker viewBox="0 0 9.6 16" markerWidth="4" markerHeight="16" orient="auto" refX="9.6" refY="8" id="markerArrowOpen"><path d="M 9.6,8 1.92,16 0,13.7 5.76,8 0,2.286 1.92,0 9.6,8 z"></path></marker></defs><g class="title"><path d="M10,10C56.7,-1.7 131.1,21.7 302.1,10.0C300.8,15.3 303.4,17.9 302.1,43.0C155.3,54.7 80.1,31.3 10.0,43.0C8.7,30.2 11.3,37.7 10.0,10.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="15" y="29" style="font-size: 16px; font-family: danielbd;"><tspan x="15">Customer auth flow - new user</tspan></text></g><g class="actor"><path d="M10,53C48.3,59.4 131.4,46.6 169.8,53.0C171.5,65.5 168.1,70.9 169.8,96.0C84.9,89.6 66.5,102.4 10.0,96.0C8.3,77.4 11.7,66.7 10.0,53.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="20" y="77" style="font-size: 16px; font-family: danielbd;"><tspan x="20">CustomerMobile</tspan></text></g><g class="actor"><path d="M10,642C92.5,648.4 47.9,635.6 169.8,642.0C168.1,659.5 171.5,670.2 169.8,685.0C144.2,691.4 35.6,678.6 10.0,685.0C11.7,678.1 8.3,674.2 10.0,642.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="20" y="666" style="font-size: 16px; font-family: danielbd;"><tspan x="20">CustomerMobile</tspan></text></g><path d="M89.9,96.0C68.1,183.4 111.7,459.6 89.9,642.0" stroke="#000000" fill="none" style="stroke-width: 2;"></path><g class="actor"><path d="M355.0859375,53C372.7,55.5 394.0,50.5 418.8,53.0C420.5,59.9 417.0,89.1 418.8,96.0C365.3,93.5 408.6,98.5 355.1,96.0C353.4,67.4 356.8,88.7 355.1,53.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="365.0859375" y="77" style="font-size: 16px; font-family: danielbd;"><tspan x="365.0859375">Auth</tspan></text></g><g class="actor"><path d="M355.0859375,642C365.3,644.5 370.4,639.5 418.8,642.0C420.5,678.1 417.0,648.9 418.8,685.0C365.3,682.5 370.6,687.5 355.1,685.0C356.8,652.3 353.4,648.9 355.1,642.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="365.0859375" y="666" style="font-size: 16px; font-family: danielbd;"><tspan x="365.0859375">Auth</tspan></text></g><path d="M386.9,96.0C408.8,421.4 365.1,337.6 386.9,642.0" stroke="#000000" fill="none" style="stroke-width: 2;"></path><g class="actor"><path d="M457.234375,53C518.5,57.5 475.0,48.5 568.6,53.0C570.3,82.2 566.9,85.7 568.6,96.0C488.0,100.5 492.5,91.5 457.2,96.0C455.5,89.1 459.0,59.9 457.2,53.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="467.234375" y="77" style="font-size: 16px; font-family: danielbd;"><tspan x="467.234375">*Facebook*</tspan></text></g><g class="actor"><path d="M457.234375,642C495.6,646.5 484.0,637.5 568.6,642.0C570.3,652.3 566.9,648.9 568.6,685.0C542.3,689.5 488.1,680.5 457.2,685.0C455.5,674.7 459.0,652.3 457.2,642.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="467.234375" y="666" style="font-size: 16px; font-family: danielbd;"><tspan x="467.234375">*Facebook*</tspan></text></g><path d="M512.9,96.0C534.7,279.6 491.1,511.0 512.9,642.0" stroke="#000000" fill="none" style="stroke-width: 2;"></path><g class="actor"><path d="M797.5703125,53C834.6,55.5 819.6,50.5 861.2,53.0C863.0,80.6 859.5,78.5 861.2,96.0C846.0,93.5 836.0,98.5 797.6,96.0C795.9,86.8 799.3,60.7 797.6,53.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="807.5703125" y="77" style="font-size: 16px; font-family: danielbd;"><tspan x="807.5703125">User</tspan></text></g><g class="actor"><path d="M797.5703125,642C846.0,644.5 815.9,639.5 861.2,642.0C863.0,657.5 859.5,664.4 861.2,685.0C835.7,682.5 842.8,687.5 797.6,685.0C799.3,652.5 795.9,666.2 797.6,642.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="807.5703125" y="666" style="font-size: 16px; font-family: danielbd;"><tspan x="807.5703125">User</tspan></text></g><path d="M829.4,96.0C807.6,501.9 851.2,223.9 829.4,642.0" stroke="#000000" fill="none" style="stroke-width: 2;"></path><g class="actor"><path d="M881.2421875,53C944.7,48.6 932.7,57.4 990.4,53.0C992.1,70.7 988.7,59.9 990.4,96.0C964.2,91.6 945.2,100.4 881.2,96.0C879.5,74.1 883.0,85.7 881.2,53.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="891.2421875" y="77" style="font-size: 16px; font-family: danielbd;"><tspan x="891.2421875">Credential</tspan></text></g><g class="actor"><path d="M881.2421875,642C935.7,637.6 918.2,646.4 990.4,642.0C992.1,658.3 988.7,678.1 990.4,685.0C907.4,680.6 898.7,689.4 881.2,685.0C883.0,652.3 879.5,661.2 881.2,642.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="891.2421875" y="666" style="font-size: 16px; font-family: danielbd;"><tspan x="891.2421875">Credential</tspan></text></g><path d="M935.8,96.0C914.0,416.4 957.7,227.0 935.8,642.0" stroke="#000000" fill="none" style="stroke-width: 2;"></path><g class="actor"><path d="M1010.4140625,53C1102.4,57.4 1027.9,48.6 1119.9,53.0C1121.7,71.4 1118.2,83.8 1119.9,96.0C1033.2,91.6 1102.4,100.4 1010.4,96.0C1008.7,60.3 1012.1,64.8 1010.4,53.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="1020.4140625" y="77" style="font-size: 16px; font-family: danielbd;"><tspan x="1020.4140625">Customer</tspan></text></g><g class="actor"><path d="M1010.4140625,642C1027.9,637.6 1036.7,646.4 1119.9,642.0C1118.2,654.1 1121.7,674.7 1119.9,685.0C1093.7,680.6 1066.9,689.4 1010.4,685.0C1012.1,652.8 1008.7,674.7 1010.4,642.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="1020.4140625" y="666" style="font-size: 16px; font-family: danielbd;"><tspan x="1020.4140625">Customer</tspan></text></g><path d="M1065.2,96.0C1043.3,227.0 1087.0,183.4 1065.2,642.0" stroke="#000000" fill="none" style="stroke-width: 2;"></path><g class="signal"><text x="99.890625" y="123.5" style="font-size: 16px; font-family: danielbd;"><tspan x="99.890625">/sign-in-facebook :facebookToken</tspan></text><path d="M89.9,139.0C195.4,150.9 269.0,127.1 386.9,139.0" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></path></g><g class="signal"><text x="396.921875" y="166.5" style="font-size: 16px; font-family: danielbd;"><tspan x="396.921875">Verify token</tspan></text><path d="M386.9,182.0C407.1,187.0 492.7,177.0 512.9,182.0" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></path></g><g class="signal"><text x="418.03125" y="209.5" style="font-size: 16px; font-family: danielbd;"><tspan x="418.03125">fbUser</tspan></text><path d="M512.9,225.0C487.3,230.0 435.7,220.0 386.9,225.0" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></path></g><g class="signal"><text x="516.4921875" y="252.5" style="font-size: 16px; font-family: danielbd;"><tspan x="512.4296875">get user by fbUser.id</tspan></text><path d="M386.9,268.0C664.9,250.3 493.1,285.7 829.4,268.0" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></path></g><g class="signal"><text x="593.890625" y="295.5" style="font-size: 16px; font-family: danielbd;"><tspan x="593.890625">null</tspan></text><path d="M829.4,311.0C615.2,293.3 716.6,328.7 386.9,311.0" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></path></g><g class="signal"><text x="396.921875" y="338.5" style="font-size: 16px; font-family: danielbd;"><tspan x="396.921875">createUser {:type :customer :email fbUser.email}</tspan></text><path d="M386.9,354.0C637.8,336.3 536.1,371.7 829.4,354.0" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></path></g><g class="signal"><text x="589.1171875" y="381.5" style="font-size: 16px; font-family: danielbd;"><tspan x="589.1171875">user</tspan></text><path d="M829.4,397.0C723.2,414.7 758.6,379.3 386.9,397.0" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></path></g><g class="signal"><text x="402.1953125" y="424.5" style="font-size: 16px; font-family: danielbd;"><tspan x="402.1953125">createCredential :user user :type 'facebook' :fb-id fbUser.id</tspan></text><path d="M386.9,440.0C518.7,418.0 474.7,462.0 935.8,440.0" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></path></g><g class="signal"><text x="471.94140625" y="467.5" style="font-size: 16px; font-family: danielbd;"><tspan x="471.94140625">/create-customer :name fbUser.name :photo fbUser.photo</tspan></text><path d="M386.9,483.0C776.2,455.9 549.7,510.1 1065.2,483.0" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></path></g><g class="signal"><text x="685.33984375" y="510.5" style="font-size: 16px; font-family: danielbd;"><tspan x="685.33984375">customer</tspan></text><path d="M1065.2,526.0C837.6,498.9 773.6,553.1 386.9,526.0" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></path></g><g class="note"><path d="M273.9140625,546C328.2,537.0 317.9,555.0 499.9,546.0C501.2,551.8 498.6,553.9 499.9,579.0C463.8,588.0 365.4,570.0 273.9,579.0C272.6,571.1 275.2,554.4 273.9,546.0" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></path><text x="278.9140625" y="565" style="font-size: 16px; font-family: danielbd;"><tspan x="278.9140625">Generate token for user</tspan></text></g><g class="signal"><text x="189.96875" y="606.5" style="font-size: 16px; font-family: danielbd;"><tspan x="189.96875">200 token</tspan></text><path d="M386.9,622.0C161.2,633.9 178.9,610.1 89.9,622.0" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></path></g></svg>